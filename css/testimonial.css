/* Gallery (Our Recent Work) — Swiper carousel with lazy images */
(function () {
  const hasReducedMotion = () =>
    window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  function doInit() {
    const el = document.querySelector('.gallerySwiper');
    if (!el || typeof Swiper === 'undefined') return;
    if (el.dataset.inited === '1') return; // guard against double init
    el.dataset.inited = '1';

    const reduce = hasReducedMotion();

    const swiper = new Swiper(el, {
      loop: true,
      centeredSlides: true,
      speed: reduce ? 0 : 550,
      grabCursor: true,
      spaceBetween: 20,
      watchSlidesProgress: true,
      preloadImages: false,
      lazy: {
        loadPrevNext: true,
        loadOnTransitionStart: true
      },
      slidesPerView: 1.1,           // mobile "peek"
      breakpoints: {
        600:  { slidesPerView: 1.3, spaceBetween: 22 },
        820:  { slidesPerView: 2,   spaceBetween: 22, centeredSlides: false },
        1150: { slidesPerView: 2.5, spaceBetween: 24, centeredSlides: false }
      },
      pagination: { el: '.swiper-pagination', clickable: true, dynamicBullets: true },
      navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
      keyboard: { enabled: true, onlyInViewport: true },
      autoplay: reduce ? false : { delay: 6000, disableOnInteraction: false, pauseOnMouseEnter: true },
      on: {
        init(sw) {
          sw.slides.forEach(s => s.classList.add('g-slide'));
          updateActive(sw);
        },
        transitionStart: updateActive,
        resize: updateActive
      }
    });

    function updateActive(sw) {
      const count = typeof sw.params.slidesPerView === 'number' ? sw.params.slidesPerView : 1;
      sw.slides.forEach(s => {
        s.classList.add('is-dim');
        s.setAttribute('aria-hidden', 'true');
      });
      // mark the currently visible slides
      const start = sw.activeIndex;
      for (let i = 0; i < Math.ceil(count); i++) {
        const slide = sw.slides[start + i];
        if (slide) {
          slide.classList.remove('is-dim');
          slide.setAttribute('aria-hidden', 'false');
        }
      }
    }
  }

  function ensureInit() {
    const target = document.querySelector('.gallerySwiper');
    if (!target) return;
    if ('IntersectionObserver' in window) {
      const io = new IntersectionObserver((entries) => {
        entries.forEach((e) => {
          if (e.isIntersecting) {
            doInit();
            io.disconnect();
          }
        });
      }, { threshold: 0.15 });
      io.observe(target);
    } else {
      doInit();
    }
  }

  // Expose for your index loader’s initFunctions list
  window.initPhotoSection = ensureInit;

  // Fallback if this file is loaded standalone
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ensureInit);
  } else {
    ensureInit();
  }
})();
